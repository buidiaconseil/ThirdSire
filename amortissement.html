<!DOCTYPE html>
<html>
   <title>Amortisation Linéaire et Dégressif Comptable</title>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta charset="UTF-8"/>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
      <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
      <script></script>
      <style>
         #customers {
         font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
         border-collapse: collapse;
         width: 100%;
         }
         #customers td, #customers th {
         border: 1px solid #ddd;
         padding: 8px;
         }
         #customers tr:nth-child(even){background-color: #f2f2f2;}
         #customers tr:hover {background-color: #ddd;}
         #customers th {
         padding-top: 12px;
         padding-bottom: 12px;
         text-align: left;
         background-color: #4CAF50;
         color: white;
         }
      </style>
   </head>
   <body>
      <p>Demonstrate fadeIn() with different parameters.</p>
      <p>Date de début: <input type="text" id="datepicker"></p>
      <script>
         function rescan(){
             var parts =$( "#datepicker" ).val().split('/');
                 var mydate = new Date(parts[2], parts[1] - 1, parts[0]); 
                 var ann=$('#annId').val();
                 var redate = new Date(mydate.getTime()-1000*60*60*24);
                 redate.setFullYear(parseInt(mydate.getFullYear()) + parseInt($('#annId').val()));
                 
                 $( "#datefinal" ).val(redate.toLocaleDateString() );
                 if($( "#type" ).val()=="L"){
                  build();
                 }else{
                     buildDegressif();
                 }
         }
         function dateDiff(date1, date2) {
             dt1 = new Date(date1);
             dt2 = new Date(date2);
             return Math.floor((Date.UTC(dt2.getFullYear(), dt2.getMonth(), dt2.getDate()) - Date.UTC(dt1.getFullYear(), dt1.getMonth(), dt1.getDate()) ) /(1000 * 60 * 60 * 24));
         }
         function buildDegressif(){
             var parts =$( "#datepicker" ).val().split('/');
                 
                 var mydate = new Date(parts[2], parts[1] - 1, parts[0]); 
                 var ann=$('#annId').val();
                 var redate = new Date((mydate.getTime()-1000*60*60*24));
                 redate.setFullYear(parseInt(mydate.getFullYear()) + parseInt($('#annId').val()));
              
                 var finPremiereAnnee=new Date(mydate.getFullYear(),11,31);
                 var nbJourPrem=dateDiff(mydate,finPremiereAnnee)
                 if(nbJourPrem>=360){
                     nbJourPrem=360;
                 }
                 var taux=1/ann;
                 var residuel=1.25;
                 var date2001=new Date(2001,0,1);
                 var date20081=new Date(2008,11,3);
                 var date20082=new Date(2008,11,4);
                 var date2009=new Date(2009,11,31);
                 
         
                 if(dateCheck(date2001,mydate,date20081)){
                     residuel=1.25;
                     if(ann>=7){
                         residuel=2.25;
                     }
                     if(ann==5 | ann==6){
                         residuel=1.75;
                     }
                 }else
                 if(dateCheck(date2001,mydate,date20081)){
                     residuel=1.75;
                     if(ann>=7){
                         residuel=2.75;
                     }
                     if(ann==5 | ann==6){
                         residuel=2.25;
                     }
                 }else{
                     residuel=1.25;
                     if(ann>=7){
                         residuel=2.25;
                     }
                     if(ann==5 | ann==6){
                         residuel=1.75;
                     }
                 }
                 $( "#residuel" ).val(residuel);
                 tauxdegressif=residuel/ann;
                 $( "#tauxdegres" ).val((tauxdegressif*100.0).toFixed(2));
                 var baseFiscal=$('#amortir').val();
                 
                 var baseAmort=$('#amortir').val()-$('#restant').val();
                 $('#baseAmort').val(baseAmort.toFixed(2))
                 $('#draw').empty();

                 var content = "<table id=\"customers\" border=1>";
                 content+="<thead><tr><th colspan=\"2\">Dates</th><th colspan=\"3\">Amortissement Fiscal</th><th colspan=\"3\">Amortissement Comptable</th><th>Amortissement Dérogatoire</th></tr>";
                 content+="<tr><th>Date de début</th><th>Date de fin</th><th>Calcul de l’amortissement</th><th>Montant de l’amortissement</th><th>Amortissements cumulés</th><th>Calcul de l’amortissement</th><th>Montant de l’amortissement</th><th>Amortissements cumulés</th><th>Dotations/Reprises</th></tr></thead>";
                 var valueCompFiscal=(baseFiscal*(nbJourPrem/360)*tauxdegressif);
                 var valueTotalFiscal=valueCompFiscal;
                 var valueComp=(baseAmort*(nbJourPrem/360)/ann);
                 var valueTotal=valueComp;
                 content += '<tbody><tr><td>' + mydate.toLocaleDateString() + '</td><td>'+finPremiereAnnee.toLocaleDateString()+'</td>';
                 content += '<td>'+baseFiscal+'*('+nbJourPrem+'/360)*'+(tauxdegressif*100).toFixed(2)+'%</td><td>'+valueCompFiscal.toFixed(2)+'</td><td>'+valueTotalFiscal.toFixed(2)+'</td>';
                 
                 content += '<td>'+baseAmort+'*('+nbJourPrem+'/360)/'+ann+'</td><td>'+valueComp.toFixed(2)+'</td><td>'+valueTotal.toFixed(2)+'</td><td>'+(valueCompFiscal-valueComp).toFixed(2)+'</td></tr>';
                 
                 var prevDate=new Date(finPremiereAnnee.getTime()+1000*60*60*24);
                 valueComp=(baseAmort/ann);
                 var valueDero=0;
                 for(i=0; i<ann-1; i++){
                     if(valueDero<0){
                        tauxdegressif=1/(ann-i-1);
                     }
                     
                     baseFiscal=baseFiscal-valueCompFiscal;
                     valueCompFiscal=(baseFiscal*tauxdegressif);
                     valueTotalFiscal+=valueCompFiscal;
                     valueTotal+=valueComp;
                     var beginDate=new Date(prevDate.getTime());
                     var endDate=new Date(prevDate.getTime()-1000*60*60*24);
                     endDate.setFullYear(parseInt(prevDate.getFullYear()) + 1);
                     valueDero=valueCompFiscal-valueComp;
                     
                     content += '<tr><td>' + beginDate.toLocaleDateString() +'</td><td>'+endDate.toLocaleDateString()+'</td>';
                     content += '<td>'+baseFiscal.toFixed(2)+'*'+(tauxdegressif*100).toFixed(2)+'%</td><td>'+valueCompFiscal.toFixed(2)+'<td>'+valueTotalFiscal.toFixed(2)+'</td>';
                     content += '<td>'+baseAmort+'/'+ann+'</td><td>'+valueComp.toFixed(2)+'<td>'+valueTotal.toFixed(2)+'</td><td>'+(valueDero).toFixed(2)+'</td></tr>';
                     prevDate=new Date(endDate.getTime()+1000*60*60*24)
                 }
                 tauxdegressif=1.0;
                 valueCompFiscal=0;
                 valueTotalFiscal+=valueCompFiscal;
                 valueComp=(baseAmort*((360-nbJourPrem)/360)/ann);
                 valueTotal+=valueComp;
                 var redate = new Date(mydate.getTime()-1000*60*60*24);
                 redate.setFullYear(parseInt(mydate.getFullYear()) + parseInt($('#annId').val()));
                 content += '<tr><td>' + prevDate.toLocaleDateString() + '</td><td>'+redate.toLocaleDateString()+'</td>';
                 content += '<td></td><td></td><td></td>';
                 content += '<td>'+baseAmort+'*('+(360-nbJourPrem)+'/360)/'+ann+'</td><td>'+valueComp.toFixed(2)+'</td><td>'+valueTotal.toFixed(2)+'</td><td>'+(valueCompFiscal-valueComp).toFixed(2)+'</td></tr>';
                 
                 content += "</tbody></table>"
                 $('#draw').append(content);
         }
         
         function dateCheck(from,to,check) {
         
         var fDate,lDate,cDate;
         fDate = Date.parse(from);
         lDate = Date.parse(to);
         cDate = Date.parse(check);
         
         if((cDate <= lDate && cDate >= fDate)) {
         return true;
         }
         return false;
         }
         
         function build(){
             var parts =$( "#datepicker" ).val().split('/');
                 
                 var mydate = new Date(parts[2], parts[1] - 1, parts[0]); 
                 var ann=$('#annId').val();
                 var redate = new Date((mydate.getTime()-1000*60*60*24));
                 redate.setFullYear(parseInt(mydate.getFullYear()) + parseInt($('#annId').val()));
              
                 var finPremiereAnnee=new Date(mydate.getFullYear(),11,31);
                 var nbJourPrem=dateDiff(mydate,finPremiereAnnee)
                 if(nbJourPrem>=360){
                     nbJourPrem=360;
                 }
                 var taux=1/ann;
                 var baseFiscal=$('#amortir').val();
                 
                 var baseAmort=$('#amortir').val()-$('#restant').val();
                 $('#baseAmort').val(baseAmort.toFixed(2))
         
                 $('#draw').empty();
                 var content = "<table id=\"customers\" border=1>";
                 content+="<thead><tr><th colspan=\"2\">Dates</th><th colspan=\"3\">Amortissement Fiscal</th><th colspan=\"3\">Amortissement Comptable</th><th>Amortissement Dérogatoire</th></tr>";
                 content+="<tr><th>Date de début</th><th>Date de fin</th><th>Calcul de l’amortissement</th><th>Montant de l’amortissement</th><th>Amortissements cumulés</th><th>Calcul de l’amortissement</th><th>Montant de l’amortissement</th><th>Amortissements cumulés</th><th>Dotations/Reprises</th></tr></thead>";
                 var valueCompFiscal=(baseFiscal*(nbJourPrem/360)/ann);
                 var valueTotalFiscal=valueCompFiscal;
                 var valueComp=(baseAmort*(nbJourPrem/360)/ann);
                 var valueTotal=valueComp;
                 content += '<tbody><tr><td>' + mydate.toLocaleDateString() + '</td><td>'+finPremiereAnnee.toLocaleDateString()+'</td>';
                 content += '<td>'+baseFiscal+'*('+nbJourPrem+'/360)/'+ann+'</td><td>'+valueCompFiscal.toFixed(2)+'</td><td>'+valueTotalFiscal.toFixed(2)+'</td>';
                 
                 content += '<td>'+baseAmort+'*('+nbJourPrem+'/360)/'+ann+'</td><td>'+valueComp.toFixed(2)+'</td><td>'+valueTotal.toFixed(2)+'</td><td>'+(valueCompFiscal-valueComp).toFixed(2)+'</td></tr>';
                 
                 var prevDate=new Date(finPremiereAnnee.getTime()+1000*60*60*24);
                 valueComp=(baseAmort/ann);
                 valueCompFiscal=(baseFiscal/ann);
                 for(i=0; i<ann-1; i++){
                     
                     valueTotalFiscal+=valueCompFiscal;
                     valueTotal+=valueComp;
                     var beginDate=new Date(prevDate.getTime());
                     var endDate=new Date(prevDate.getTime()-1000*60*60*24);
                     endDate.setFullYear(parseInt(prevDate.getFullYear()) + 1);
                     
                     
                     content += '<tr><td>' + beginDate.toLocaleDateString() +'</td><td>'+endDate.toLocaleDateString()+'</td>';
                     content += '<td>'+baseFiscal+'/'+ann+'</td><td>'+valueCompFiscal.toFixed(2)+'<td>'+valueTotalFiscal.toFixed(2)+'</td>';
                     content += '<td>'+baseAmort+'/'+ann+'</td><td>'+valueComp.toFixed(2)+'<td>'+valueTotal.toFixed(2)+'</td><td>'+(valueCompFiscal-valueComp).toFixed(2)+'</td></tr>';
                     prevDate=new Date(endDate.getTime()+1000*60*60*24)
                 }
                 valueCompFiscal=(baseFiscal*((360-nbJourPrem)/360)/ann);
                 valueTotalFiscal+=valueCompFiscal;
                 valueComp=(baseAmort*((360-nbJourPrem)/360)/ann);
                 valueTotal+=valueComp;
                 var redate = new Date(mydate.getTime()-1000*60*60*24);
                 redate.setFullYear(parseInt(mydate.getFullYear()) + parseInt($('#annId').val()));
                 content += '<tr><td>' + prevDate.toLocaleDateString() + '</td><td>'+redate.toLocaleDateString()+'</td>';
                 content += '<td>'+baseFiscal+'*('+(360-nbJourPrem)+'/360)/'+ann+'</td><td>'+valueCompFiscal.toFixed(2)+'</td><td>'+valueTotalFiscal.toFixed(2)+'</td>';
                 content += '<td>'+baseAmort+'*('+(360-nbJourPrem)+'/360)/'+ann+'</td><td>'+valueComp.toFixed(2)+'</td><td>'+valueTotal.toFixed(2)+'</td><td>'+(valueCompFiscal-valueComp).toFixed(2)+'</td></tr>';
                 
                 content += "</tbody></table>"
                 $('#draw').append(content);
         
                 
                 
         }
             $( function() {
               $( "#datepicker" ).datepicker({
         dateFormat: "dd/mm/yy"
         });
               $.datepicker.setDefaults( $.datepicker.regional[ "fr" ] );
               $( "#datepicker" ).change(rescan);
               $( "#annId" ).change(rescan);
               $( "#amortir" ).change(rescan);
               $( "#restant" ).change(rescan);
               $( "#type" ).change(rescan);
             } );
             
      </script>
      <label>Nombre d'années</label>
      <select id="annId" name="annee">
      </select>
      <script>
         for(var i=0;i<30;i++){
             $('#annId').append($('<option>', {
             value: i+1,
             text: i+1
         }));
         }
      </script>
      <p>Date de fin: <input type="text" id="datefinal" disabled></p>
      <p>Valeur vénale à amortir <input type="text" id="amortir" value="1000.0"></p>
      <p>Valeur résiduelle à l'issue du plan <input type="text" id="restant" value="0"></p>
      <p>Base amortissable <input type="text" id="baseAmort" disabled></p>
      <label>Type ammortissement</label>
      <select id="type" name="type">
         <option value="L">Linéaire</option>
         <option value="D">Dégressif</option>
      </select>
      <p>Valeur résiduel: <input type="text" id="residuel" disabled></p>
      <p>Taux amortissement dégressif: <input type="text" id="tauxdegres" disabled></p>
      <div id="draw"></div>
   </body>
